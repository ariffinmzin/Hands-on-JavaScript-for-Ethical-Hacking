var express = require('express');
var cookieParser = require('cookie-parser');
var bodyParser = require('body-parser');
var escape = require('escape-html');
var serialize = require('node-serialize');
const cors = require("cors");
var app = express();

app.use(cookieParser())
app.use(bodyParser.json());
app.use(require('cors')({
  origin: function (origin, callback) {
    callback(null, origin);
  },
  credentials: true
}));

app.post('/', function (req, res) {
  console.log(`/ [POST] ->`);
  if (req.cookies.profile) {
    var str = new Buffer.from(req.cookies.profile, 'base64').toString();
    var profile = serialize.unserialize(str);
    if (profile.name) {
      var data = {name: profile.name, startsWith: profile.name[0], length: profile.name.length };
      console.log(`/ [POST] <- ${JSON.stringify(data)}`);
      res.json(data);
    }
  }
  else{
    res.json({name:"", startsWith: "", length: "" });
  }
});

app.post('/changeProfile', function (req, res) {
  console.log(`/changeProfile [POST] -> ${JSON.stringify(req.body)}`);

  res.cookie('profile', new Buffer.from(JSON.stringify({ name: req.body.name })).toString('base64'), {
    maxAge: 900000,
    httpOnly: true
  });

  var data = { "startsWith": req.body.name[0], "length": req.body.name.length };
  console.log(`/changeProfile [POST] <- ${JSON.stringify(data)}`);
  res.json(data);
});

app.listen(3003, function () {
  console.log("server is running on port 3003");
});
